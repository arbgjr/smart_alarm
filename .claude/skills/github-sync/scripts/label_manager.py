#!/usr/bin/env python3
"""
Label Manager - Gerencia labels SDLC no repositorio GitHub.

Usage:
    python label_manager.py ensure    # Cria labels se nao existem
    python label_manager.py list      # Lista labels existentes
    python label_manager.py check     # Verifica se labels SDLC existem
    python label_manager.py delete    # Remove labels SDLC (cuidado!)
"""

import argparse
import json
import subprocess
import sys
from dataclasses import dataclass
from typing import Optional


@dataclass
class Label:
    """Representa um label do GitHub."""
    name: str
    color: str
    description: str


# Labels SDLC - Fases
PHASE_LABELS = [
    Label("phase:0", "0E8A16", "SDLC Phase 0 - Preparation"),
    Label("phase:1", "1D76DB", "SDLC Phase 1 - Discovery"),
    Label("phase:2", "5319E7", "SDLC Phase 2 - Requirements"),
    Label("phase:3", "FBCA04", "SDLC Phase 3 - Architecture"),
    Label("phase:4", "F9D0C4", "SDLC Phase 4 - Planning"),
    Label("phase:5", "C5DEF5", "SDLC Phase 5 - Implementation"),
    Label("phase:6", "BFD4F2", "SDLC Phase 6 - Quality"),
    Label("phase:7", "D4C5F9", "SDLC Phase 7 - Release"),
    Label("phase:8", "0052CC", "SDLC Phase 8 - Operations"),
]

# Labels SDLC - Complexidade
COMPLEXITY_LABELS = [
    Label("complexity:0", "C2E0C6", "Quick Flow - Bug fixes, typos"),
    Label("complexity:1", "FEF2C0", "Feature - Simple feature"),
    Label("complexity:2", "F9D0C4", "BMAD Method - New service"),
    Label("complexity:3", "E99695", "Enterprise - Compliance critical"),
]

# Labels SDLC - Tipo
TYPE_LABELS = [
    Label("type:story", "D93F0B", "User Story"),
    Label("type:task", "0075CA", "Implementation Task"),
    Label("type:epic", "7057FF", "Epic - Large initiative"),
]

# Labels SDLC - Automacao
AUTO_LABELS = [
    Label("sdlc:auto", "EDEDED", "Auto-generated by SDLC Agentico"),
]

ALL_LABELS = PHASE_LABELS + COMPLEXITY_LABELS + TYPE_LABELS + AUTO_LABELS


def run_gh_command(args: list[str], capture_output: bool = True) -> subprocess.CompletedProcess:
    """Executa comando gh e retorna resultado."""
    try:
        result = subprocess.run(
            ["gh"] + args,
            capture_output=capture_output,
            text=True,
            check=False
        )
        return result
    except FileNotFoundError:
        print("Erro: GitHub CLI (gh) nao encontrado. Instale com: brew install gh", file=sys.stderr)
        sys.exit(1)


def get_existing_labels() -> list[str]:
    """Retorna lista de labels existentes no repositorio."""
    result = run_gh_command(["label", "list", "--json", "name"])
    if result.returncode != 0:
        print(f"Erro ao listar labels: {result.stderr}", file=sys.stderr)
        return []

    try:
        labels = json.loads(result.stdout)
        return [label["name"] for label in labels]
    except json.JSONDecodeError:
        return []


def create_label(label: Label) -> bool:
    """Cria um label no repositorio."""
    result = run_gh_command([
        "label", "create", label.name,
        "--color", label.color,
        "--description", label.description,
        "--force"  # Atualiza se ja existe
    ])

    if result.returncode == 0:
        print(f"  [OK] {label.name}")
        return True
    else:
        print(f"  [ERRO] {label.name}: {result.stderr.strip()}", file=sys.stderr)
        return False


def delete_label(name: str) -> bool:
    """Remove um label do repositorio."""
    result = run_gh_command(["label", "delete", name, "--yes"])
    return result.returncode == 0


def ensure_labels() -> int:
    """Cria todos os labels SDLC se nao existem."""
    print("Criando labels SDLC...")
    existing = get_existing_labels()
    created = 0
    updated = 0

    for label in ALL_LABELS:
        if label.name in existing:
            # Atualizar para garantir cor e descricao corretas
            if create_label(label):
                updated += 1
        else:
            if create_label(label):
                created += 1

    print(f"\nResumo: {created} criados, {updated} atualizados")
    return 0


def list_labels() -> int:
    """Lista todos os labels do repositorio."""
    result = run_gh_command(["label", "list", "--json", "name,color,description"])
    if result.returncode != 0:
        print(f"Erro ao listar labels: {result.stderr}", file=sys.stderr)
        return 1

    try:
        labels = json.loads(result.stdout)
        sdlc_labels = [l for l in labels if l["name"].startswith(("phase:", "complexity:", "type:", "sdlc:"))]
        other_labels = [l for l in labels if not l["name"].startswith(("phase:", "complexity:", "type:", "sdlc:"))]

        print("Labels SDLC:")
        for label in sdlc_labels:
            print(f"  - {label['name']} (#{label['color']}) - {label.get('description', '')}")

        print(f"\nOutros labels: {len(other_labels)}")
        return 0
    except json.JSONDecodeError:
        print("Erro ao processar resposta JSON", file=sys.stderr)
        return 1


def check_labels() -> int:
    """Verifica se todos os labels SDLC existem."""
    print("Verificando labels SDLC...")
    existing = set(get_existing_labels())
    required = {label.name for label in ALL_LABELS}

    missing = required - existing
    present = required & existing

    print(f"\nPresentes: {len(present)}/{len(required)}")

    if missing:
        print("\nLabels faltando:")
        for name in sorted(missing):
            print(f"  - {name}")
        print("\nExecute 'python label_manager.py ensure' para criar os labels faltando.")
        return 1
    else:
        print("Todos os labels SDLC estao presentes.")
        return 0


def delete_sdlc_labels() -> int:
    """Remove todos os labels SDLC do repositorio."""
    print("Removendo labels SDLC...")
    existing = get_existing_labels()
    deleted = 0

    for label in ALL_LABELS:
        if label.name in existing:
            if delete_label(label.name):
                print(f"  [OK] Removido: {label.name}")
                deleted += 1
            else:
                print(f"  [ERRO] Falha ao remover: {label.name}")

    print(f"\nRemovidos: {deleted} labels")
    return 0


def get_phase_label(phase: int) -> Optional[str]:
    """Retorna o nome do label para uma fase."""
    if 0 <= phase <= 8:
        return f"phase:{phase}"
    return None


def get_complexity_label(level: int) -> Optional[str]:
    """Retorna o nome do label para um nivel de complexidade."""
    if 0 <= level <= 3:
        return f"complexity:{level}"
    return None


def get_type_label(item_type: str) -> Optional[str]:
    """Retorna o nome do label para um tipo de item."""
    valid_types = {"story", "task", "epic"}
    if item_type.lower() in valid_types:
        return f"type:{item_type.lower()}"
    return None


def main():
    parser = argparse.ArgumentParser(
        description="Gerencia labels SDLC no repositorio GitHub"
    )
    parser.add_argument(
        "action",
        choices=["ensure", "list", "check", "delete"],
        help="Acao a executar"
    )

    args = parser.parse_args()

    if args.action == "ensure":
        return ensure_labels()
    elif args.action == "list":
        return list_labels()
    elif args.action == "check":
        return check_labels()
    elif args.action == "delete":
        confirm = input("Tem certeza que deseja remover todos os labels SDLC? (yes/no): ")
        if confirm.lower() == "yes":
            return delete_sdlc_labels()
        else:
            print("Operacao cancelada.")
            return 0


if __name__ == "__main__":
    sys.exit(main())
